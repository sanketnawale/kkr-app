name: Deploy KKR Scraper to Contabo
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH to Contabo
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CONTABO_HOST }}
          port: ${{ secrets.CONTABO_PORT }}
          username: ${{ secrets.CONTABO_USER }}
          password: ${{ secrets.CONTABO_PASSWORD }}
          script_timeout: 600
          script: |
            echo " Deploying KKR scraper with MongoDB Atlas..."
            docker stop kkr-api 2>/dev/null || true
            docker rm kkr-api 2>/dev/null || true
            
            docker run -d --name kkr-api --init --ipc=host \
              -p 3001:3000 \
              -e MONGODB_URI="mongodb+srv://sanketnawale101_db_user:Fantacy%40321@cluster.uentncd.mongodb.net/kkr?retryWrites=true&w=majority" \
              mcr.microsoft.com/playwright:v1.58.0-noble \
              sh -c "
                apt-get update -qq && apt-get install -y git &&
                rm -rf /home/pwuser/app /app || true &&
                mkdir -p /home/pwuser &&
                cd /home/pwuser &&
                git clone https://github.com/sanketnawale/kkr-app.git app &&
                cd app &&
                npm install @nestjs/schedule @nestjs/axios --legacy-peer-deps &&
                npm install --legacy-peer-deps &&
                npx playwright install --with-deps &&
                npx nest build &&
                npm run start:prod
              "
            echo " Deployed! https://${{ secrets.CONTABO_HOST }}:3001/portfolio/stats"
