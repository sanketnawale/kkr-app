name: Deploy KKR Scraper to Contabo
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Contabo (5min timeout)
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 10
        with:
          host: ${{ secrets.CONTABO_HOST }}
          port: ${{ secrets.CONTABO_PORT}}
          username: ${{ secrets.CONTABO_USER }}
          password: ${{ secrets.CONTABO_PASSWORD }}
          script_timeout: 300   # 5 minutes
          script_stop: true
          script: |
            echo " Deploying KKR Scraper..."
            docker stop kkr-api kkr-mongo || true
            docker rm kkr-api kkr-mongo || true
            docker network rm kkr-net || true
            docker network create kkr-net
            docker run -d --name kkr-mongo --network kkr-net -p 27017:27017 -v kkr-data:/data/db mongo:latest
            
            docker run -d --name kkr-api --network kkr-net --restart always -p 3001:3000 \
              -e MONGO_URI="mongodb://kkr-mongo:27017/kkr" \
              mcr.microsoft.com/playwright:v1.58.0-noble sh -c "
              apt-get update -qq && apt-get install -y git &&
              git clone https://github.com/sanketnawale/kkr-app.git /app &&
              cd /app && npm ci --legacy-peer-deps &&
              npx playwright install --with-deps &&
              npm run build && npm run start:prod"
            
            echo " Deployed! curl http://localhost:3001/portfolio/stats"
